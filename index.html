<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduFlow OS</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --win-bg: #c0c0c0; 
            --win-blue: #000080; 
            --win-border-light: #ffffff;
            --win-border-dark: #808080; 
            --desktop-bg: #008080;
            --text-color: black;
        }
        body.dark-mode {
            --win-bg: #2b2b2b; 
            --win-blue: #000040; 
            --win-border-light: #444;
            --win-border-dark: #000; 
            --desktop-bg: #1a1a1a; 
            --text-color: #00ff00;
        }

        body { 
            background-color: var(--desktop-bg); 
            background-size: cover;
            background-position: center;
            font-family: 'VT323', monospace; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            color: var(--text-color); 
            user-select: none; 
        }
        
        .crt::before { 
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; 
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%); 
            z-index: 25000; background-size: 100% 3px; pointer-events: none; 
        }
        
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--desktop-bg); z-index: 15000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .login-window {
            width: 250px; background: var(--win-bg); border: 2px solid;
            border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light);
            padding: 15px; text-align: center; box-shadow: 4px 4px 0px rgba(0,0,0,1);
        }

        .window { 
            position: absolute; background: var(--win-bg); border: 2px solid; 
            border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light); 
            box-shadow: 1px 1px 0 1px #000; z-index: 100; display: none; min-width: 200px; 
            box-sizing: border-box;
        }
        .title-bar { background: var(--win-border-dark); color: #ccc; padding: 4px 8px; display: flex; justify-content: space-between; align-items: center; cursor: move; }
        .window.active .title-bar { background: var(--win-blue); color: white; }
        
        .window-body { padding: 10px; color: black; }
        .btn-controls button { cursor: pointer; background: var(--win-bg); border: 1px solid #000; font-weight: bold; padding: 0 4px; margin-left: 2px; height: 18px; line-height: 14px;}

        .taskbar { position: fixed; bottom: 0; width: 100%; height: 35px; background: var(--win-bg); border-top: 2px solid var(--win-border-light); display: none; align-items: center; padding: 0 5px; z-index: 10000; gap: 5px; box-sizing: border-box;}
        
        #start-menu {
            position: absolute; bottom: 35px; left: 0; width: 220px; background: var(--win-bg);
            border: 2px solid; border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light);
            display: none; flex-direction: column; z-index: 11000;
        }
        .start-item { padding: 8px; border-bottom: 1px solid #888; cursor: pointer; color: black; display: flex; align-items: center; gap: 10px;}
        .start-item:hover { background: var(--win-blue); color: white; }

        .icon { width: 75px; text-align: center; color: white; cursor: pointer; margin: 15px; float: left; text-shadow: 2px 2px #000; font-size: 14px; padding: 5px; }
        .icon:hover { outline: 1px dotted #fff; background: rgba(255,255,255,0.1); }
        .icon span { font-size: 24px; }
        
        button { background: var(--win-bg); border: 2px solid; border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light); font-family: inherit; cursor: pointer; color: black; }
        button:active { border-style: inset; }
        
        input, textarea, select { font-family: inherit; margin-bottom: 5px; width: 100%; box-sizing: border-box; background: white; color: black; border: 2px inset; }

        #calc-display { background: #fff; border: 2px inset; text-align: right; padding: 5px; font-size: 20px; margin-bottom: 5px; min-height: 30px; color: black; }
        .calc-btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; }

        .task-item { border-bottom: 1px solid #888; padding: 8px 4px; display: flex; flex-direction: column; gap: 4px; font-size: 13px; color: black; background: #fff; margin-bottom: 2px; }
        .completed { text-decoration: line-through; opacity: 0.6; background: #dcdcdc; }
        .minimized-tab { padding: 2px 10px; background: #c0c0c0; border: 2px outset; font-size: 12px; cursor: pointer; color: black; min-width: 60px; text-align: center; }
        .minimized-tab:active { border-style: inset; }

        .ms-grid { display: grid; grid-template-columns: repeat(8, 22px); gap: 1px; background: #888; border: 2px inset; }
        .ms-cell { width: 22px; height: 22px; background: #c0c0c0; text-align: center; cursor: pointer; border: 1px solid #eee; line-height: 22px; }

        #calendar-popup {
            position: absolute; bottom: 40px; right: 10px; width: 200px; background: var(--win-bg);
            border: 2px solid; border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light);
            display: none; padding: 10px; z-index: 11000; text-align: center; color: black;
        }

        .tm-tabs { display: flex; border-bottom: 2px solid var(--win-border-dark); margin-bottom: 10px; }
        .tm-tab { padding: 2px 10px; cursor: pointer; background: #eee; border: 1px solid var(--win-border-dark); border-bottom: none; font-size: 12px; }
        .tm-tab.active { background: var(--win-bg); font-weight: bold; margin-bottom: -2px; padding-bottom: 4px; border-bottom: none; }
        .tm-meter-container { background: #000; height: 20px; border: 2px inset; position: relative; margin-bottom: 5px; }
        .tm-meter-fill { background: #00ff00; height: 100%; width: 0%; transition: width 0.5s; }
        .tm-meter-text { position: absolute; width: 100%; text-align: center; color: white; font-size: 12px; line-height: 18px; mix-blend-mode: difference; }

        .profile-pic { width: 60px; height: 60px; background: #888; border: 2px inset; display: inline-block; font-size: 40px; line-height: 60px; overflow: hidden; }

        /* Sticky Note Style */
        .sticky-note {
            position: absolute; width: 150px; height: 150px; background: #ffffa5; border: 1px solid #d4d48a;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2); padding: 10px; z-index: 5; color: black; cursor: move;
        }
        .sticky-note textarea {
            background: transparent; border: none; width: 100%; height: 80%; resize: none; overflow: hidden; font-family: 'VT323', monospace;
        }
        .sticky-header { display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; margin-bottom: 5px; cursor: move; }

        ::-webkit-scrollbar { width: 16px; background: #dfdfdf; }
        ::-webkit-scrollbar-thumb { background: #c0c0c0; border: 2px outset #fff; }
    </style>
</head>
<body class="crt" oncontextmenu="showContextMenu(event)">

<div id="bios-screen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;color:#00ff00;z-index:30000;padding:40px; box-sizing: border-box;"></div>

<div id="login-screen">
    <div class="login-window">
        <div style="background: var(--win-blue); color: white; margin: -15px -15px 15px -15px; padding: 4px;">SYSTEM_AUTH</div>
        <div id="login-avatar" class="profile-pic" style="margin-bottom: 10px;">üë§</div>
        <div id="login-username" style="font-weight: bold; margin-bottom: 10px;">Admin</div>
        <input type="password" id="login-input" placeholder="Pass: 1234" style="text-align: center;" onkeydown="if(event.key==='Enter') attemptLogin()">
        <button onclick="attemptLogin()" style="width: 100%; margin-top: 5px;">UNLOCK</button>
        <div id="login-error" style="color: red; font-size: 12px; margin-top: 5px; height: 14px;"></div>
    </div>
</div>

<div id="start-menu">
    <div style="background: var(--win-blue); color: white; padding: 8px; font-weight: bold; display: flex; align-items: center; gap: 5px;">
        <span id="start-avatar" style="font-size: 16px;">üë§</span> <span id="start-username">EduFlow OS</span>
    </div>
    <div class="start-item" onclick="openWin('profile-win'); hideUI();"><span>üë§</span> User Profile</div>
    <div class="start-item" onclick="openWin('wp-win'); hideUI();"><span>üé®</span> Appearance</div>
    <div class="start-item" onclick="openWin('explorer-win'); hideUI();"><span>üìÇ</span> Documents</div>
    <div class="start-item" onclick="openWin('sys-info-win'); hideUI();"><span>‚öôÔ∏è</span> Sys_Info</div>
    <div class="start-item" onclick="toggleTaskManager(); hideUI();"><span>üìã</span> Task_Manager</div>
    <div class="start-item" onclick="openWin('term-win'); hideUI();"><span>üìü</span> Terminal</div>
    <div class="start-item" onclick="addSticky(); hideUI();"><span>üìå</span> Add Sticky Note</div>
    <div class="start-item" onclick="openWin('bin-win'); hideUI();"><span>üóëÔ∏è</span> Recycle Bin</div>
    <div class="start-item" onclick="openWin('run-win'); hideUI();"><span>üöÄ</span> Run...</div>
    <hr>
    <div class="start-item" onclick="restartSystem();"><span>üîÑ</span> Restart</div>
</div>

<div id="calendar-popup">
    <div id="cal-header" style="font-weight:bold; margin-bottom:5px;"></div>
    <div id="cal-date" style="font-size:30px;"></div>
    <div id="cal-full" style="font-size:12px;"></div>
</div>

<div id="context-menu" style="position:absolute; background:var(--win-bg); border:2px solid; display:none; z-index:20000; width:120px;">
    <div class="start-item" style="border:none;" onclick="openWin('notepad-win'); hideUI();">New Note</div>
    <div class="start-item" style="border:none;" onclick="addSticky(); hideUI();">New Sticky</div>
    <div class="start-item" style="border:none;" onclick="restartSystem()">Refresh</div>
</div>

<div id="desktop" style="display:none;" onclick="hideUI()">
    <div id="sticky-container"></div>
    <div class="icon" onclick="openWin('task-win')"><span>üìù</span><br>Add_Task</div>
    <div class="icon" onclick="openWin('explorer-win')"><span>üìÅ</span><br>Documents</div>
    <div class="icon" onclick="openWin('notepad-win')"><span>üñäÔ∏è</span><br>Notepad</div>
    <div class="icon" onclick="openWin('calc-win')"><span>üßÆ</span><br>Calculator</div>
    <div class="icon" onclick="openWin('paint-win')"><span>üé®</span><br>Paint</div>
    <div class="icon" onclick="openWin('mine-win')"><span>üí£</span><br>Mines</div>

    <div class="window" id="profile-win" style="width:250px;"><div class="title-bar"><span>USER_PROFILE</span><button onclick="closeWin('profile-win')">X</button></div><div class="window-body">User Name: <input type="text" id="pref-username" placeholder="Admin">Avatar Emoji: <input type="text" id="pref-avatar" placeholder="üë§"><button onclick="saveProfile()" style="width:100%;">SAVE PROFILE</button></div></div>
    <div class="window" id="sys-info-win" style="width:280px;"><div class="title-bar"><span>SYSTEM_INFO</span><button onclick="closeWin('sys-info-win')">X</button></div><div class="window-body"><div style="display:flex; gap:10px; color:black;"><div style="font-size:40px;">üíø</div><div><strong>EduFlow OS Platinum</strong><br>Version 2026.1<br>Build: 6.3.9600</div></div><hr><p style="color:black; font-size:12px;">Registered to: <strong id="info-user">Admin</strong></p><p style="color:black; font-size:12px;">Processors: Intel(R) Core(TM) i9 Equivalent</p><p style="color:black; font-size:12px;">Memory: 1024MB RAM</p><button onclick="triggerBSOD()" style="width:100%; font-size:10px;">Run Stress Test (Fatal)</button></div></div>
    <div class="window" id="task-win" style="width:220px;"><div class="title-bar"><span>TASK_ADD</span><div class="btn-controls"><button onclick="minimizeWin('task-win')">_</button><button onclick="closeWin('task-win')">X</button></div></div><div class="window-body"><input type="text" id="taskName" placeholder="Task Name"><select id="taskPriority"><option value="low">Low Priority</option><option value="med">Medium Priority</option><option value="high">High Priority</option></select><input type="date" id="taskDate"><button onclick="addTask()" style="width:100%;">SAVE TASK</button><div id="save-status" style="font-size: 10px; color: blue; text-align: center; margin-top: 5px;"></div></div></div>
    <div class="window" id="view-tasks-win" style="width:320px;"><div class="title-bar"><span>TASK_MANAGER</span><div class="btn-controls"><button onclick="minimizeWin('view-tasks-win')">_</button><button onclick="closeWin('view-tasks-win')">X</button></div></div><div class="window-body"><div class="tm-tabs"><div class="tm-tab active" id="tab-tasks-btn" onclick="switchTMTab('tasks')">Tasks</div><div class="tm-tab" id="tab-performance-btn" onclick="switchTMTab('performance')">Performance</div><div class="tm-tab" id="tab-processes-btn" onclick="switchTMTab('processes')">Processes</div></div><div id="tm-tab-tasks"><div id="task-view-list" style="height:180px; overflow-y:auto; background:#eee; border:2px inset; padding:5px; margin-bottom:5px;"></div><button onclick="clearTasks()" style="width:100%; color:red;">CLEAR ALL DATA</button></div><div id="tm-tab-performance" style="display:none;">CPU Usage:<div class="tm-meter-container"><div id="cpu-fill" class="tm-meter-fill"></div><div id="cpu-text" class="tm-meter-text">0%</div></div>Memory (RAM):<div class="tm-meter-container"><div id="ram-fill" class="tm-meter-fill"></div><div id="ram-text" class="tm-meter-text">0MB / 1024MB</div></div>System Uptime: <span id="uptime-text">0s</span></div><div id="tm-tab-processes" style="display:none;"><div id="process-list" style="height:180px; overflow-y:auto; background:#fff; border:2px inset; padding:5px;"></div></div></div></div>
    <div class="window" id="bin-win" style="width:250px;"><div class="title-bar"><span>RECYCLE_BIN</span><div class="btn-controls"><button onclick="minimizeWin('bin-win')">_</button><button onclick="closeWin('bin-win')">X</button></div></div><div class="window-body"><div id="bin-list" style="height:120px; overflow-y:auto; background:#fff; border:2px inset; padding:5px; margin-bottom:5px;"></div><button onclick="emptyBin()" style="width:100%;">EMPTY BIN</button></div></div>
    <div class="window" id="calc-win" style="width:200px;"><div class="title-bar"><span>CALC</span><div class="btn-controls"><button onclick="minimizeWin('calc-win')">_</button><button onclick="closeWin('calc-win')">X</button></div></div><div class="window-body"><div id="calc-display">0</div><div class="calc-btns"><button onclick="calcNum('7')">7</button><button onclick="calcNum('8')">8</button><button onclick="calcNum('9')">9</button><button onclick="calcOp('/')">/</button><button onclick="calcNum('4')">4</button><button onclick="calcNum('5')">5</button><button onclick="calcNum('6')">6</button><button onclick="calcOp('*')">*</button><button onclick="calcNum('1')">1</button><button onclick="calcNum('2')">2</button><button onclick="calcNum('3')">3</button><button onclick="calcOp('-')">-</button><button onclick="calcNum('0')">0</button><button onclick="calcClear()">C</button><button onclick="calcRes()">=</button><button onclick="calcOp('+')">+</button></div></div></div>
    <div class="window" id="paint-win" style="width:225px;"><div class="title-bar"><span>PAINT</span><div class="btn-controls"><button onclick="minimizeWin('paint-win')">_</button><button onclick="closeWin('paint-win')">X</button></div></div><div class="window-body"><canvas id="paint-canvas" width="200" height="150" style="background:white; border:1px solid #000;"></canvas><br><input type="color" id="paint-color"><button onclick="clearPaint()">CLR</button></div></div>
    <div class="window" id="mine-win"><div class="title-bar"><span>MINES</span><div class="btn-controls"><button onclick="minimizeWin('mine-win')">_</button><button onclick="closeWin('mine-win')">X</button></div></div><div class="window-body"><div id="mine-grid" class="ms-grid"></div></div></div>
    <div class="window" id="term-win" style="width:400px;"><div class="title-bar"><span>CMD.EXE</span><div class="btn-controls"><button onclick="minimizeWin('term-win')">_</button><button onclick="closeWin('term-win')">X</button></div></div><div class="window-body" style="background: black; padding: 5px;"><div id="term-out" style="height: 150px; overflow-y: auto; color:#00ff00; font-size:14px;">EduFlow Console [Version 6.3]<br></div><div style="display:flex; color:#00ff00;">C:\&gt;<input type="text" id="term-in" onkeydown="if(event.key==='Enter') runCmd()" style="background:black; color:#00ff00; border:none; outline:none;"></div></div></div>
    <div class="window" id="run-win" style="width:250px;"><div class="title-bar"><span>RUN</span><button onclick="closeWin('run-win')">X</button></div><div class="window-body">Type name of program to launch:<br><input type="text" id="run-input" placeholder="e.g. calc, paint, mines" onkeydown="if(event.key==='Enter') executeRun()"><button onclick="executeRun()" style="width:100%;">OK</button></div></div>
    <div class="window" id="wp-win" style="width:250px;"><div class="title-bar"><span>THEMES</span><button onclick="closeWin('wp-win')">X</button></div><div class="window-body">Wallpaper URL:<input type="text" id="wp-url" placeholder="https://image.jpg"><button onclick="setCustomWP()" style="width:100%;">APPLY</button><hr><button onclick="toggleDarkMode()" style="width:100%;">DARK MODE</button></div></div>
    <div class="window" id="explorer-win" style="width:300px;"><div class="title-bar"><span>DOCS</span><button onclick="closeWin('explorer-win')">X</button></div><div class="window-body" id="explorer-body" style="background:white; min-height:100px; display:flex; flex-wrap:wrap;"></div></div>
    <div class="window" id="notepad-win" style="width:300px;"><div class="title-bar"><span>NOTEPAD</span><button onclick="closeWin('notepad-win')">X</button></div><div class="window-body"><input type="text" id="note-name" placeholder="file.txt"><textarea id="note-content" style="height:150px;"></textarea><button onclick="saveNote()" style="width:100%;">SAVE</button></div></div>
</div>

<div class="taskbar" id="main-taskbar">
    <button onclick="toggleStart()" style="font-weight:bold;">START</button>
    <button onclick="toggleTaskManager()" style="margin-left:5px;">üìã Task Manager</button>
    <div id="minimized-container" style="display:flex; gap:5px; margin-left:10px;"></div>
    <div style="margin-left:auto; border: 2px inset; padding: 2px 10px; background: #eee; color: #000; font-weight: bold; cursor:pointer;" onclick="toggleCalendar()" id="clock-container"><span id="clock">00:00</span></div>
</div>

<script>
    let files = JSON.parse(localStorage.getItem('sysFiles')) || [];
    let trash = JSON.parse(localStorage.getItem('sysTrash')) || [];
    let tasks = JSON.parse(localStorage.getItem('sysTasks')) || [];
    let stickies = JSON.parse(localStorage.getItem('sysStickies')) || [];
    let startTime = Date.now();
    let zIndex = 100;

    const startupSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3');
    const clickSound = new Audio('https://www.soundjay.com/buttons/button-16.mp3');

    document.addEventListener('click', (e) => {
        if(e.target.tagName === 'BUTTON') clickSound.play();
    });

    function runBios() {
        const bios = document.getElementById('bios-screen');
        const logs = ["RESTORING PLATINUM KERNEL v6.3...", "CHECKING VIDEO RAM...", "LOADING PERSISTENT STORAGE...", "TOGGLE ENGINE INITIALIZED...", "READY."];
        let i = 0; bios.innerHTML = "";
        const interval = setInterval(() => {
            if(i < logs.length) bios.innerHTML += logs[i++] + "<br>";
            else { clearInterval(interval); bios.style.display = 'none'; document.getElementById('login-screen').style.display = 'flex'; }
        }, 300);
    }

    function attemptLogin() {
        if(document.getElementById('login-input').value === "1234") {
            startupSound.play();
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('desktop').style.display = 'block';
            document.getElementById('main-taskbar').style.display = 'flex';
            loadSettings(); makeDraggable(); updateClock(); updateTaskView(); initMinesweeper(); initPaint(); updatePerformance(); renderStickies();
        } else {
            document.getElementById('login-error').innerText = "Invalid Access Code";
        }
    }

    function triggerBSOD() {
        const bsod = document.createElement('div');
        bsod.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:#0000AA;color:#fff;z-index:99999;padding:50px;font-family:monospace;font-size:18px;line-height:1.5;";
        bsod.innerHTML = `<p>*** FATAL ERROR ***</p><p>A problem has been detected and EduFlow OS has been shut down...</p><p>Technical Information:<br>*** STOP: 0x00000050</p><p style="margin-top:50px;">Press any key to restart...</p>`;
        document.body.appendChild(bsod);
        window.addEventListener('keydown', () => location.reload());
    }

    // STICKY NOTE LOGIC
    function addSticky() {
        stickies.push({ content: "", x: 200, y: 200 });
        saveAll();
        renderStickies();
    }

    function renderStickies() {
        const container = document.getElementById('sticky-container');
        container.innerHTML = stickies.map((s, i) => `
            <div class="sticky-note" style="left:${s.x}px; top:${s.y}px;" id="sticky-${i}">
                <div class="sticky-header" onmousedown="dragSticky(event, ${i})"><span>Sticky Note</span><span onclick="removeSticky(${i})" style="cursor:pointer">X</span></div>
                <textarea oninput="updateSticky(${i}, this.value)">${s.content}</textarea>
            </div>
        `).join('');
    }

    function dragSticky(e, i) {
        let el = document.getElementById(`sticky-${i}`);
        let offsetX = e.clientX - el.offsetLeft;
        let offsetY = e.clientY - el.offsetTop;
        document.onmousemove = (ev) => {
            el.style.left = (ev.clientX - offsetX) + 'px';
            el.style.top = (ev.clientY - offsetY) + 'px';
            stickies[i].x = ev.clientX - offsetX;
            stickies[i].y = ev.clientY - offsetY;
        };
        document.onmouseup = () => { document.onmousemove = null; saveAll(); };
    }

    function updateSticky(i, val) { stickies[i].content = val; saveAll(); }
    function removeSticky(i) { stickies.splice(i, 1); saveAll(); renderStickies(); }

    // PRESERVED LOGIC
    function toggleTaskManager() {
        const win = document.getElementById('view-tasks-win');
        if (win.style.display === 'block') closeWin('view-tasks-win');
        else openWin('view-tasks-win');
    }

    function saveProfile() {
        const user = document.getElementById('pref-username').value || "Admin";
        const avatar = document.getElementById('pref-avatar').value || "üë§";
        localStorage.setItem('sysUser', user);
        localStorage.setItem('sysAvatar', avatar);
        applyProfile(user, avatar);
        closeWin('profile-win');
    }

    function applyProfile(user, avatar) {
        document.getElementById('login-username').innerText = user;
        document.getElementById('login-avatar').innerText = avatar;
        document.getElementById('start-username').innerText = user;
        document.getElementById('start-avatar').innerText = avatar;
        document.getElementById('info-user').innerText = user;
    }

    function switchTMTab(tab) {
        document.getElementById('tm-tab-tasks').style.display = tab === 'tasks' ? 'block' : 'none';
        document.getElementById('tm-tab-performance').style.display = tab === 'performance' ? 'block' : 'none';
        document.getElementById('tm-tab-processes').style.display = tab === 'processes' ? 'block' : 'none';
        document.querySelectorAll('.tm-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${tab}-btn`).classList.add('active');
        if(tab === 'processes') updateProcessList();
        if(tab === 'tasks') updateTaskView();
    }

    function addTask() {
        const name = document.getElementById('taskName').value;
        if(!name) return;
        tasks.push({ name: name, prio: document.getElementById('taskPriority').value, date: document.getElementById('taskDate').value || "No Date", done: false });
        saveAll(); updateTaskView(); document.getElementById('taskName').value = "";
    }

    function updateTaskView() {
        const list = document.getElementById('task-view-list');
        list.innerHTML = tasks.map((t, i) => `<div class="task-item ${t.done?'completed':''}"><div style="display:flex; align-items:center; gap:10px;"><input type="checkbox" ${t.done?'checked':''} onclick="toggleTask(${i})"><strong>${t.name}</strong></div><div style="font-size:10px; margin-left:25px;">[${t.prio}] Due: ${t.date} <span onclick="deleteTask(${i})" style="color:red; cursor:pointer; margin-left:10px;">(Remove)</span></div></div>`).join('') || "No tasks.";
    }

    function toggleTask(i) { tasks[i].done = !tasks[i].done; saveAll(); updateTaskView(); }
    function deleteTask(i) { trash.push({name: tasks[i].name, type:'task', data: tasks[i]}); tasks.splice(i,1); saveAll(); updateTaskView(); updateBinList(); }
    function clearTasks() { tasks = []; saveAll(); updateTaskView(); }

    function updatePerformance() {
        setInterval(() => {
            const cpu = Math.floor(Math.random() * 15) + 5;
            const ram = Math.floor(Math.random() * 50) + 200;
            if(document.getElementById('cpu-fill')){
                document.getElementById('cpu-fill').style.width = cpu + "%";
                document.getElementById('cpu-text').innerText = cpu + "%";
                document.getElementById('ram-fill').style.width = (ram/1024*100) + "%";
                document.getElementById('ram-text').innerText = ram + "MB / 1024MB";
                document.getElementById('uptime-text').innerText = Math.floor((Date.now() - startTime)/1000) + "s";
            }
        }, 1000);
    }

    function updateProcessList() {
        const list = document.getElementById('process-list');
        const windows = document.querySelectorAll('.window');
        let html = '<table style="width:100%; font-size:12px; border-collapse:collapse; color:black;"><tr style="background:#ddd;"><td>Image Name</td><td>Status</td><td>Action</td></tr>';
        windows.forEach(win => {
            if(win.style.display === 'block') {
                const name = win.querySelector('.title-bar span').innerText;
                html += `<tr><td>${name}</td><td style="color:green;">Running</td><td><button onclick="closeWin('${win.id}'); updateProcessList();">End Task</button></td></tr>`;
            }
        });
        html += '</table>';
        list.innerHTML = html;
    }

    function loadSettings() {
        const wp = localStorage.getItem('sysWP');
        if(wp) document.body.style.backgroundImage = `url('${wp}')`;
        if(localStorage.getItem('sysDarkMode') === 'true') document.body.classList.add('dark-mode');
        const user = localStorage.getItem('sysUser') || "Admin";
        const avatar = localStorage.getItem('sysAvatar') || "üë§";
        applyProfile(user, avatar);
    }

    function executeRun() {
        const val = document.getElementById('run-input').value.toLowerCase();
        const map = { 'calc': 'calc-win', 'paint': 'paint-win', 'mines': 'mine-win', 'docs': 'explorer-win', 'notes': 'notepad-win', 'term': 'term-win', 'profile': 'profile-win', 'info': 'sys-info-win' };
        if(map[val]) openWin(map[val]);
        else alert("Program not found.");
        closeWin('run-win');
    }

    function toggleCalendar() {
        const cal = document.getElementById('calendar-popup');
        cal.style.display = cal.style.display === 'block' ? 'none' : 'block';
        const d = new Date();
        document.getElementById('cal-header').innerText = d.toLocaleString('default', { month: 'long' }) + " " + d.getFullYear();
        document.getElementById('cal-date').innerText = d.getDate();
        document.getElementById('cal-full').innerText = d.toDateString();
    }

    function updateBinList() {
        const list = document.getElementById('bin-list');
        list.innerHTML = trash.map((f, i) => `<div>üóëÔ∏è ${f.name} <button onclick="restoreFromBin(${i})">Restore</button></div>`).join('') || "Empty";
    }
    function restoreFromBin(i) {
        if(trash[i].type === 'task') tasks.push(trash[i].data);
        trash.splice(i, 1); saveAll(); updateTaskView(); updateBinList();
    }
    function emptyBin() { trash = []; saveAll(); updateBinList(); }

    let curV = "0", pV = null, opr = null, rst = false;
    function calcNum(n) { if(curV === "0" || rst) { curV = n; rst = false; } else { curV += n; } document.getElementById('calc-display').innerText = curV; }
    function calcOp(o) { pV = curV; opr = o; rst = true; }
    function calcRes() { if(!opr) return; let a=parseFloat(pV), b=parseFloat(curV), res=0; if(opr==='+')res=a+b; if(opr==='-')res=a-b; if(opr==='*')res=a*b; if(opr==='/')res=a/b; curV=String(res); opr=null; rst=true; document.getElementById('calc-display').innerText = curV; }
    function calcClear() { curV="0"; pV=null; opr=null; rst=false; document.getElementById('calc-display').innerText="0"; }

    function saveNote() {
        const name = document.getElementById('note-name').value || "note.txt";
        files.push({ name, content: document.getElementById('note-content').value });
        saveAll(); renderExplorer();
    }
    function renderExplorer() {
        const body = document.getElementById('explorer-body');
        body.innerHTML = files.map((f, i) => `<div style="margin:10px; text-align:center; cursor:pointer; color:black;" onclick="openFile(${i})">üìÑ<br><span style="font-size:10px;">${f.name}</span></div>`).join('');
    }
    function openFile(i) {
        openWin('notepad-win');
        document.getElementById('note-name').value = files[i].name;
        document.getElementById('note-content').value = files[i].content;
    }

    function initPaint() {
        const canvas = document.getElementById('paint-canvas'); const ctx = canvas.getContext('2d'); let draw = false;
        canvas.onmousedown = (e) => { draw = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
        canvas.onmouseup = () => draw = false;
        canvas.onmousemove = (e) => { if(draw) { ctx.strokeStyle = document.getElementById('paint-color').value; ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
    }
    function clearPaint() { document.getElementById('paint-canvas').getContext('2d').clearRect(0,0,200,150); }
    function initMinesweeper() {
        const g = document.getElementById('mine-grid'); g.innerHTML = "";
        for(let i=0; i<64; i++){
            let c = document.createElement('div'); c.className="ms-cell";
            c.onclick = function(){ this.style.background="#fff"; this.innerText="0"; };
            g.appendChild(c);
        }
    }

    function openWin(id) {
        const win = document.getElementById(id);
        win.style.display = 'block';
        win.style.zIndex = ++zIndex;
        updateTaskbar();
    }
    function closeWin(id) { document.getElementById(id).style.display = 'none'; updateTaskbar(); }
    function minimizeWin(id) { document.getElementById(id).style.display = 'none'; updateTaskbar(); }
    function toggleStart() { const m = document.getElementById('start-menu'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
    function hideUI() { document.getElementById('start-menu').style.display = 'none'; document.getElementById('calendar-popup').style.display = 'none'; document.getElementById('context-menu').style.display = 'none'; }
    function updateClock() { setInterval(() => { const d = new Date(); document.getElementById('clock').innerText = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0'); }, 1000); }
    function saveAll() {
        localStorage.setItem('sysFiles', JSON.stringify(files));
        localStorage.setItem('sysTrash', JSON.stringify(trash));
        localStorage.setItem('sysTasks', JSON.stringify(tasks));
        localStorage.setItem('sysStickies', JSON.stringify(stickies));
    }
    function restartSystem() { location.reload(); }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('sysDarkMode', document.body.classList.contains('dark-mode')); }
    function setCustomWP() { const url = document.getElementById('wp-url').value; document.body.style.backgroundImage = `url('${url}')`; localStorage.setItem('sysWP', url); }

    function updateTaskbar() {
        const container = document.getElementById('minimized-container');
        container.innerHTML = "";
        document.querySelectorAll('.window').forEach(win => {
            if(win.style.display === 'block') {
                const tab = document.createElement('div');
                tab.className = "minimized-tab";
                tab.innerText = win.querySelector('.title-bar span').innerText;
                tab.onclick = () => openWin(win.id);
                container.appendChild(tab);
            }
        });
    }

    function makeDraggable() {
        document.querySelectorAll('.window').forEach(win => {
            const header = win.querySelector('.title-bar');
            header.onmousedown = (e) => {
                zIndex++;
                win.style.zIndex = zIndex;
                let offsetX = e.clientX - win.offsetLeft;
                let offsetY = e.clientY - win.offsetTop;
                document.onmousemove = (e) => {
                    win.style.left = (e.clientX - offsetX) + 'px';
                    win.style.top = (e.clientY - offsetY) + 'px';
                };
                document.onmouseup = () => { document.onmousemove = null; };
            };
        });
    }

    function showContextMenu(e) {
        e.preventDefault();
        const menu = document.getElementById('context-menu');
        menu.style.display = 'block';
        menu.style.left = e.clientX + 'px';
        menu.style.top = e.clientY + 'px';
    }

    function runCmd() {
        const i = document.getElementById('term-in'), o = document.getElementById('term-out');
        o.innerHTML += `<br>C:\&gt; ${i.value}`;
        if(i.value === 'cls') o.innerHTML = "";
        else if(i.value === 'ver') o.innerHTML += "<br>EduFlow Platinum [Version 6.3]";
        else if(i.value === 'help') o.innerHTML += "<br>Available: cls, ver, help, exit, date";
        else if(i.value === 'date') o.innerHTML += "<br>" + new Date().toString();
        else if(i.value === 'exit') closeWin('term-win');
        else o.innerHTML += `<br>'${i.value}' is not recognized.`;
        i.value = "";
        o.scrollTop = o.scrollHeight;
    }

    runBios();
</script>
</body>
</html>
