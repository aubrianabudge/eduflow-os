<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduFlow OS</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --win-bg: #c0c0c0; 
            --win-blue: #000080; 
            --win-border-light: #ffffff;
            --win-border-dark: #808080; 
            --desktop-bg: #008080;
            --text-color: black;
        }
        body.dark-mode {
            --win-bg: #2b2b2b; 
            --win-blue: #000040; 
            --win-border-light: #444;
            --win-border-dark: #000; 
            --desktop-bg: #1a1a1a; 
            --text-color: #00ff00;
        }

        body { 
            background-color: var(--desktop-bg); 
            background-size: cover;
            background-position: center;
            font-family: 'VT323', monospace; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            color: var(--text-color); 
            user-select: none; 
        }
        
        .crt::before { 
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; 
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%); 
            z-index: 25000; background-size: 100% 3px; pointer-events: none; 
        }
        
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--desktop-bg); z-index: 15000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .login-window {
            width: 250px; background: var(--win-bg); border: 2px solid;
            border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light);
            padding: 15px; text-align: center; box-shadow: 4px 4px 0px rgba(0,0,0,1);
        }

        .window { 
            position: absolute; background: var(--win-bg); border: 2px solid; 
            border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light); 
            box-shadow: 1px 1px 0 1px #000; z-index: 10; display: none; min-width: 200px; 
            box-sizing: border-box;
        }
        .title-bar { background: var(--win-border-dark); color: #ccc; padding: 4px 8px; display: flex; justify-content: space-between; align-items: center; cursor: move; }
        .window.active .title-bar { background: var(--win-blue); color: white; }
        
        .window-body { padding: 10px; color: black; }
        .btn-controls button { cursor: pointer; background: var(--win-bg); border: 1px solid #000; font-weight: bold; padding: 0 4px; margin-left: 2px; height: 18px; line-height: 14px;}

        .taskbar { position: fixed; bottom: 0; width: 100%; height: 35px; background: var(--win-bg); border-top: 2px solid var(--win-border-light); display: none; align-items: center; padding: 0 5px; z-index: 10000; gap: 5px; box-sizing: border-box;}
        
        #start-menu {
            position: absolute; bottom: 35px; left: 0; width: 220px; background: var(--win-bg);
            border: 2px solid; border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light);
            display: none; flex-direction: column; z-index: 11000;
        }
        .start-item { padding: 8px; border-bottom: 1px solid #888; cursor: pointer; color: black; display: flex; align-items: center; gap: 10px;}
        .start-item:hover { background: var(--win-blue); color: white; }

        .icon { width: 75px; text-align: center; color: white; cursor: pointer; margin: 15px; float: left; text-shadow: 2px 2px #000; font-size: 14px; padding: 5px; }
        .icon:hover { outline: 1px dotted #fff; background: rgba(255,255,255,0.1); }
        .icon span { font-size: 24px; }
        
        button { background: var(--win-bg); border: 2px solid; border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light); font-family: inherit; cursor: pointer; color: black; }
        button:active { border-style: inset; }
        
        input, textarea, select { font-family: inherit; margin-bottom: 5px; width: 100%; box-sizing: border-box; background: white; color: black; border: 2px inset; }

        #calc-display { background: #fff; border: 2px inset; text-align: right; padding: 5px; font-size: 20px; margin-bottom: 5px; min-height: 30px; color: black; }
        .calc-btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; }

        .minimized-tab { padding: 2px 10px; background: #c0c0c0; border: 2px outset; font-size: 12px; cursor: pointer; color: black; min-width: 60px; text-align: center; }

        .ms-grid { display: grid; grid-template-columns: repeat(8, 22px); gap: 1px; background: #888; border: 2px inset; }
        .ms-cell { width: 22px; height: 22px; background: #c0c0c0; text-align: center; cursor: pointer; border: 1px solid #eee; line-height: 22px; font-weight: bold; }
        .ms-cell.revealed { background: #fff; }
        .ms-cell.bomb { background: #ff0000; }

        #calendar-popup {
            position: absolute; bottom: 40px; right: 10px; width: 200px; background: var(--win-bg);
            border: 2px solid; border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light);
            display: none; padding: 10px; z-index: 11000; text-align: center; color: black;
        }

        .tm-tabs { display: flex; border-bottom: 2px solid var(--win-border-dark); margin-bottom: 10px; }
        .tm-tab { padding: 2px 10px; cursor: pointer; background: #eee; border: 1px solid var(--win-border-dark); border-bottom: none; font-size: 12px; }
        .tm-tab.active { background: var(--win-bg); font-weight: bold; margin-bottom: -2px; padding-bottom: 4px; border-bottom: none; }
        .tm-meter-container { background: #000; height: 20px; border: 2px inset; position: relative; margin-bottom: 5px; }
        .tm-meter-fill { background: #00ff00; height: 100%; width: 0%; transition: width 0.5s; }
        .tm-meter-text { position: absolute; width: 100%; text-align: center; color: white; font-size: 12px; line-height: 18px; mix-blend-mode: difference; }

        .profile-pic { width: 60px; height: 60px; background: #888; border: 2px inset; display: inline-block; font-size: 40px; line-height: 60px; overflow: hidden; }
        .kill-btn { background: #ff4444 !important; color: white !important; font-size: 10px; padding: 1px 4px; float: right; }
    </style>
</head>
<body class="crt" oncontextmenu="showContextMenu(event)">

<div id="bios-screen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;color:#00ff00;z-index:30000;padding:40px; box-sizing: border-box;"></div>

<div id="login-screen">
    <div class="login-window">
        <div style="background: var(--win-blue); color: white; margin: -15px -15px 15px -15px; padding: 4px;">SYSTEM_AUTH</div>
        <div id="login-avatar" class="profile-pic" style="margin-bottom: 10px;">üë§</div>
        <div id="login-username" style="font-weight: bold; margin-bottom: 10px;">Admin</div>
        <input type="password" id="login-input" placeholder="Pass: 1234" style="text-align: center;" onkeydown="if(event.key==='Enter') attemptLogin()">
        <button onclick="attemptLogin()" style="width: 100%; margin-top: 5px;">UNLOCK</button>
        <div id="login-error" style="color: red; font-size: 12px; margin-top: 5px; height: 14px;"></div>
    </div>
</div>

<div id="start-menu">
    <div style="background: var(--win-blue); color: white; padding: 8px; font-weight: bold; display: flex; align-items: center; gap: 5px;">
        <span id="start-avatar" style="font-size: 16px;">üë§</span> <span id="start-username">EduFlow OS</span>
    </div>
    <div class="start-item" onclick="openWin('profile-win'); hideUI();"><span>üë§</span> User Profile</div>
    <div class="start-item" onclick="openWin('view-tasks-win'); hideUI();"><span>üìã</span> Task Manager</div>
    <div class="start-item" onclick="openWin('sys-info-win'); hideUI();"><span>‚öôÔ∏è</span> System Info</div>
    <div class="start-item" onclick="openWin('term-win'); hideUI();"><span>üìü</span> Terminal</div>
    <div class="start-item" onclick="openWin('wp-win'); hideUI();"><span>üé®</span> Appearance</div>
    <div class="start-item" onclick="openWin('explorer-win'); hideUI();"><span>üìÇ</span> Documents</div>
    <div class="start-item" onclick="openWin('bin-win'); hideUI();"><span>üóëÔ∏è</span> Recycle Bin</div>
    <div class="start-item" onclick="openWin('run-win'); hideUI();"><span>üöÄ</span> Run...</div>
    <hr>
    <div class="start-item" onclick="restartSystem();"><span>üîÑ</span> Restart</div>
</div>

<div id="calendar-popup">
    <div id="cal-header" style="font-weight:bold; margin-bottom:5px;"></div>
    <div id="cal-date" style="font-size:30px;"></div>
    <div id="cal-full" style="font-size:12px;"></div>
</div>

<div id="context-menu" style="position:absolute; background:var(--win-bg); border:2px solid; display:none; z-index:20000; width:120px;">
    <div class="start-item" style="border:none;" onclick="openWin('notepad-win'); hideUI();">New Note</div>
    <div class="start-item" style="border:none;" onclick="restartSystem()">Refresh</div>
</div>

<div id="desktop" style="display:none;" onclick="hideUI()">
    <div class="icon" onclick="handleIconClick('task-win')"><span>üìù</span><br>Add_Task</div>
    <div class="icon" onclick="handleIconClick('explorer-win')"><span>üìÅ</span><br>Documents</div>
    <div class="icon" onclick="handleIconClick('notepad-win')"><span>üñäÔ∏è</span><br>Notepad</div>
    <div class="icon" onclick="handleIconClick('calc-win')"><span>üßÆ</span><br>Calculator</div>
    <div class="icon" onclick="handleIconClick('paint-win')"><span>üé®</span><br>Paint</div>
    <div class="icon" onclick="handleIconClick('mine-win')"><span>üí£</span><br>Mines</div>

    <div class="window" id="profile-win" style="width:250px;">
        <div class="title-bar" ondblclick="handleWinDblClick('profile-win')"><span>USER_PROFILE</span><button onclick="closeWin('profile-win')">X</button></div>
        <div class="window-body">
            User Name: <input type="text" id="pref-username" placeholder="Admin">
            Avatar Emoji: <input type="text" id="pref-avatar" placeholder="üë§">
            <button onclick="saveProfile()" style="width:100%;">SAVE PROFILE</button>
        </div>
    </div>

    <div class="window" id="sys-info-win" style="width:280px;">
        <div class="title-bar" ondblclick="handleWinDblClick('sys-info-win')"><span>SYSTEM_INFO</span><button onclick="closeWin('sys-info-win')">X</button></div>
        <div class="window-body">
            <div style="display:flex; gap:10px; color:black;">
                <div style="font-size:40px;">üíø</div>
                <div><strong>EduFlow OS Platinum</strong><br> Version 2026.1</div>
            </div>
            <p style="color:black; font-size:12px;">Registered to: <strong id="info-user">Admin</strong></p>
            <button onclick="triggerBSOD()" style="width:100%; font-size:10px;">Run Stress Test</button>
        </div>
    </div>

    <div class="window" id="task-win" style="width:220px;">
        <div class="title-bar" ondblclick="handleWinDblClick('task-win')"><span>TASK_ADD</span><div class="btn-controls"><button onclick="minimizeWin('task-win')">_</button><button onclick="closeWin('task-win')">X</button></div></div>
        <div class="window-body">
            <input type="text" id="taskName" placeholder="Task Name">
            <select id="taskPriority"><option value="low">Low</option><option value="med">Medium</option><option value="high">High</option></select>
            <input type="date" id="taskDate">
            <button onclick="addTask()" style="width:100%;">SAVE TASK</button>
        </div>
    </div>

    <div class="window" id="view-tasks-win" style="width:320px;">
        <div class="title-bar" ondblclick="handleWinDblClick('view-tasks-win')"><span>TASK_MANAGER</span><div class="btn-controls"><button onclick="minimizeWin('view-tasks-win')">_</button><button onclick="closeWin('view-tasks-win')">X</button></div></div>
        <div class="window-body">
            <div class="tm-tabs">
                <div class="tm-tab active" id="tab-tasks-btn" onclick="switchTMTab('tasks')">Tasks</div>
                <div class="tm-tab" id="tab-performance-btn" onclick="switchTMTab('performance')">Perf</div>
                <div class="tm-tab" id="tab-processes-btn" onclick="switchTMTab('processes')">Proc</div>
                <div class="tm-tab" id="tab-settings-btn" onclick="switchTMTab('settings')">Settings</div>
            </div>
            <div id="tm-tab-tasks"><div id="task-view-list" style="height:150px; overflow-y:auto; background:#eee; border:2px inset; padding:5px;"></div></div>
            <div id="tm-tab-performance" style="display:none;">
                CPU: <div class="tm-meter-container"><div id="cpu-fill" class="tm-meter-fill"></div><div id="cpu-text" class="tm-meter-text">0%</div></div>
                RAM: <div class="tm-meter-container"><div id="ram-fill" class="tm-meter-fill"></div><div id="ram-text" class="tm-meter-text">0MB</div></div>
                System Uptime: <div id="uptime-text" style="color:black; font-size:12px;">0s</div>
            </div>
            <div id="tm-tab-processes" style="display:none;"><div id="process-list" style="height:150px; overflow-y:auto; color:black; background:white; padding:4px; font-size:11px;"></div></div>
            <div id="tm-tab-settings" style="display:none; color:black;">
                <label style="font-size:12px;"><input type="checkbox" id="toggle-click-mode"> 1-Click Open / 2-Click Close</label>
            </div>
        </div>
    </div>

    <div class="window" id="mine-win">
        <div class="title-bar" ondblclick="handleWinDblClick('mine-win')"><span>MINES</span><div class="btn-controls"><button onclick="minimizeWin('mine-win')">_</button><button onclick="closeWin('mine-win')">X</button></div></div>
        <div class="window-body">
            <div id="mine-status" style="margin-bottom:5px;">Mines: 10</div>
            <div id="mine-grid" class="ms-grid"></div>
            <button onclick="initMinesweeper()" style="width:100%; margin-top:5px;">New Game</button>
        </div>
    </div>

    <div class="window" id="explorer-win" style="width:300px;">
        <div class="title-bar" ondblclick="handleWinDblClick('explorer-win')"><span>DOCS</span><button onclick="closeWin('explorer-win')">X</button></div>
        <div class="window-body" id="explorer-body" style="background:white; min-height:100px; display:flex; flex-wrap:wrap;"></div>
    </div>

    <div class="window" id="bin-win" style="width:250px;">
        <div class="title-bar" ondblclick="handleWinDblClick('bin-win')"><span>RECYCLE_BIN</span><div class="btn-controls"><button onclick="minimizeWin('bin-win')">_</button><button onclick="closeWin('bin-win')">X</button></div></div>
        <div class="window-body">
            <div id="bin-list" style="height:120px; overflow-y:auto; background:#fff; border:2px inset; padding:5px; margin-bottom:5px; color:black;"></div>
            <button onclick="emptyBin()" style="width:100%;">EMPTY BIN</button>
        </div>
    </div>

    <div class="window" id="notepad-win" style="width:300px;">
        <div class="title-bar" ondblclick="handleWinDblClick('notepad-win')"><span>NOTEPAD</span><button onclick="closeWin('notepad-win')">X</button></div>
        <div class="window-body">
            <input type="text" id="note-name" placeholder="file.txt"><textarea id="note-content" style="height:150px;"></textarea>
            <button onclick="saveNote()" style="width:100%;">SAVE</button>
        </div>
    </div>

    <div class="window" id="calc-win" style="width:200px;">
        <div class="title-bar" ondblclick="handleWinDblClick('calc-win')"><span>CALC</span><div class="btn-controls"><button onclick="minimizeWin('calc-win')">_</button><button onclick="closeWin('calc-win')">X</button></div></div>
        <div class="window-body">
            <div id="calc-display">0</div>
            <div class="calc-btns">
                <button onclick="calcNum('7')">7</button><button onclick="calcNum('8')">8</button><button onclick="calcNum('9')">9</button><button onclick="calcOp('/')">/</button>
                <button onclick="calcNum('4')">4</button><button onclick="calcNum('5')">5</button><button onclick="calcNum('6')">6</button><button onclick="calcOp('*')">*</button>
                <button onclick="calcNum('1')">1</button><button onclick="calcNum('2')">2</button><button onclick="calcNum('3')">3</button><button onclick="calcOp('-')">-</button>
                <button onclick="calcNum('0')">0</button><button onclick="calcClear()">C</button><button onclick="calcRes()">=</button><button onclick="calcOp('+')">+</button>
            </div>
        </div>
    </div>

    <div class="window" id="paint-win" style="width:225px;">
        <div class="title-bar" ondblclick="handleWinDblClick('paint-win')"><span>PAINT</span><div class="btn-controls"><button onclick="minimizeWin('paint-win')">_</button><button onclick="closeWin('paint-win')">X</button></div></div>
        <div class="window-body">
            <canvas id="paint-canvas" width="200" height="150" style="background:white; border:1px solid #000;"></canvas>
            <br><input type="color" id="paint-color"><button onclick="clearPaint()">CLR</button>
        </div>
    </div>

    <div class="window" id="term-win" style="width:400px;">
        <div class="title-bar" ondblclick="handleWinDblClick('term-win')"><span>CMD.EXE</span><div class="btn-controls"><button onclick="minimizeWin('term-win')">_</button><button onclick="closeWin('term-win')">X</button></div></div>
        <div class="window-body" style="background: black; padding: 5px;">
            <div id="term-out" style="height: 150px; overflow-y: auto; color:#00ff00; font-size:14px;">EduFlow Console [Version 6.3]<br></div>
            <div style="display:flex; color:#00ff00;">C:\&gt;<input type="text" id="term-in" onkeydown="if(event.key==='Enter') runCmd()" style="background:black; color:#00ff00; border:none; outline:none;"></div>
        </div>
    </div>

    <div class="window" id="run-win" style="width:250px;">
        <div class="title-bar" ondblclick="handleWinDblClick('run-win')"><span>RUN</span><button onclick="closeWin('run-win')">X</button></div>
        <div class="window-body">
            <input type="text" id="run-input" placeholder="e.g. calc" onkeydown="if(event.key==='Enter') executeRun()">
            <button onclick="executeRun()" style="width:100%;">OK</button>
        </div>
    </div>

    <div class="window" id="wp-win" style="width:250px;">
        <div class="title-bar" ondblclick="handleWinDblClick('wp-win')"><span>THEMES</span><button onclick="closeWin('wp-win')">X</button></div>
        <div class="window-body">
            Wallpaper URL:<input type="text" id="wp-url" placeholder="https://image.jpg">
            <button onclick="setCustomWP()" style="width:100%;">APPLY</button>
            <hr><button onclick="toggleDarkMode()" style="width:100%;">DARK MODE</button>
        </div>
    </div>
</div>

<div class="taskbar" id="main-taskbar">
    <button onclick="toggleStart()" style="font-weight:bold;">START</button>
    <button onclick="openWin('view-tasks-win')" style="margin-left:5px;">üìã Task Manager</button>
    <div id="minimized-container" style="display:flex; gap:5px; margin-left:10px;"></div>
    <div style="margin-left:auto; border: 2px inset; padding: 2px 10px; background: #eee; color: #000; font-weight: bold; cursor:pointer;" onclick="toggleCalendar()" id="clock-container"><span id="clock">00:00</span></div>
</div>

<script>
    let files = JSON.parse(localStorage.getItem('sysFiles')) || [];
    let trash = JSON.parse(localStorage.getItem('sysTrash')) || [];
    let tasks = JSON.parse(localStorage.getItem('sysTasks')) || [];
    let minimizedWindows = new Set();
    let zIndex = 100;
    let mineData = [];
    let gameOver = false;
    let bootTime = Date.now();

    window.onload = runBios;

    // Keyboard Shortcut Logic
    window.onkeydown = (e) => {
        if (e.metaKey || e.ctrlKey) {
            if (e.key === 'r') { e.preventDefault(); openWin('run-win'); }
            if (e.key === 'd') { e.preventDefault(); showDesktop(); }
            if (e.key === 'l') { e.preventDefault(); lockSystem(); }
        }
        if (e.key === 'Escape') { hideUI(); }
    };

    function showDesktop() {
        document.querySelectorAll('.window').forEach(w => {
            if(w.style.display !== 'none') minimizeWin(w.id);
        });
    }

    function lockSystem() {
        document.getElementById('desktop').style.display = 'none';
        document.getElementById('main-taskbar').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('login-input').value = "";
    }

    function handleIconClick(id) {
        openWin(id);
    }

    function handleWinDblClick(id) {
        if(document.getElementById('toggle-click-mode').checked) {
            closeWin(id);
        }
    }

    function runBios() {
        const bios = document.getElementById('bios-screen');
        const logs = ["RESTORING PLATINUM KERNEL...", "CHECKING DRIVES...", "LOADING GUI...", "READY."];
        let i = 0; bios.innerHTML = "";
        const interval = setInterval(() => {
            if(i < logs.length) bios.innerHTML += logs[i++] + "<br>";
            else { clearInterval(interval); bios.style.display = 'none'; document.getElementById('login-screen').style.display = 'flex'; }
        }, 300);
    }

    function attemptLogin() {
        if(document.getElementById('login-input').value === "1234") {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('desktop').style.display = 'block';
            document.getElementById('main-taskbar').style.display = 'flex';
            makeDraggable(); updateClock(); updateTaskView(); initMinesweeper(); initPaint(); updatePerformance(); renderExplorer(); updateBinList();
        } else { document.getElementById('login-error').innerText = "Invalid Code"; }
    }

    function openWin(id) {
        const win = document.getElementById(id);
        if(!win) return;
        win.style.display = 'block';
        win.style.zIndex = ++zIndex;
        minimizedWindows.delete(id); 
        document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
        win.classList.add('active');
        updateTaskbar();
    }

    function closeWin(id) { 
        document.getElementById(id).style.display = 'none'; 
        minimizedWindows.delete(id);
        updateTaskbar();
        updateProcessList();
    }

    function minimizeWin(id) { 
        document.getElementById(id).style.display = 'none'; 
        minimizedWindows.add(id);
        updateTaskbar(); 
    }

    function updateTaskbar() {
        const container = document.getElementById('minimized-container');
        container.innerHTML = "";
        minimizedWindows.forEach(id => {
            const win = document.getElementById(id);
            let tab = document.createElement('div');
            tab.className = 'minimized-tab';
            tab.innerText = win.querySelector('.title-bar span').innerText;
            tab.onclick = () => openWin(id);
            container.appendChild(tab);
        });
    }

    function switchTMTab(tab) {
        const tabs = ['tasks', 'performance', 'processes', 'settings'];
        tabs.forEach(t => {
            document.getElementById(`tm-tab-${t}`).style.display = (t === tab) ? 'block' : 'none';
            document.getElementById(`tab-${t}-btn`).classList.toggle('active', t === tab);
        });
        if(tab === 'processes') updateProcessList();
    }

    function updateProcessList() {
        const list = document.getElementById('process-list');
        list.innerHTML = "<strong>Active Processes:</strong><br>";
        const windows = document.querySelectorAll('.window');
        let count = 0;
        windows.forEach(w => {
            if (w.style.display !== 'none' || minimizedWindows.has(w.id)) {
                const title = w.querySelector('.title-bar span').innerText;
                const processRow = document.createElement('div');
                processRow.style.marginBottom = '5px';
                processRow.style.borderBottom = '1px solid #ddd';
                processRow.style.padding = '2px';
                processRow.innerHTML = `${title} <button class="kill-btn" onclick="closeWin('${w.id}')">KILL</button>`;
                list.appendChild(processRow);
                count++;
            }
        });
        if (count === 0) list.innerHTML += "No active applications.";
    }

    function updatePerformance() {
        setInterval(() => {
            let cpu = Math.floor(Math.random()*15)+2;
            let ram = Math.floor(Math.random()*50)+210;
            document.getElementById('cpu-fill').style.width = cpu+"%";
            document.getElementById('cpu-text').innerText = cpu+"%";
            document.getElementById('ram-fill').style.width = (ram/1024*100)+"%";
            document.getElementById('ram-text').innerText = ram + " MB";
            document.getElementById('uptime-text').innerText = Math.floor((Date.now() - bootTime)/1000) + "s";
        }, 1500);
    }

    function makeDraggable() {
        document.querySelectorAll(".window").forEach(win => {
            const title = win.querySelector(".title-bar");
            title.onmousedown = (e) => {
                if(e.target.tagName === 'BUTTON') return;
                openWin(win.id);
                let x = e.clientX - win.offsetLeft, y = e.clientY - win.offsetTop;
                document.onmousemove = (e) => { win.style.left = (e.clientX - x) + 'px'; win.style.top = (e.clientY - y) + 'px'; };
                document.onmouseup = () => { document.onmousemove = null; };
            };
        });
    }

    function initMinesweeper() {
        const g = document.getElementById('mine-grid'); g.innerHTML = "";
        mineData = []; gameOver = false;
        let bombs = new Set();
        while(bombs.size < 10) bombs.add(Math.floor(Math.random() * 64));
        for(let i=0; i<64; i++){
            mineData.push({ isBomb: bombs.has(i), revealed: false });
            let c = document.createElement('div'); c.className="ms-cell";
            c.id = "mc-"+i;
            c.onclick = () => revealMine(i);
            g.appendChild(c);
        }
        document.getElementById('mine-status').innerText = "Mines: 10";
    }
    function revealMine(i) {
        if(gameOver || mineData[i].revealed) return;
        const cell = document.getElementById("mc-"+i);
        mineData[i].revealed = true;
        if(mineData[i].isBomb) {
            cell.classList.add('bomb'); cell.innerText = "üí£"; gameOver = true;
            document.getElementById('mine-status').innerText = "GAME OVER";
            mineData.forEach((m, idx) => { if(m.isBomb) document.getElementById("mc-"+idx).innerText = "üí£"; });
        } else {
            let count = 0, r = Math.floor(i/8), c = i%8;
            for(let x=-1; x<=1; x++) for(let y=-1; y<=1; y++) {
                let nr = r+x, nc = c+y;
                if(nr>=0 && nr<8 && nc>=0 && nc<8 && mineData[nr*8+nc].isBomb) count++;
            }
            cell.classList.add('revealed'); cell.innerText = count || "";
        }
    }
    function saveNote() {
        const name = document.getElementById('note-name').value || "note.txt";
        files.push({ name, content: document.getElementById('note-content').value });
        saveAll(); renderExplorer();
    }
    function renderExplorer() {
        const body = document.getElementById('explorer-body');
        body.innerHTML = files.map((f, i) => `<div style="margin:10px; text-align:center; color:black; width:50px;">üìÑ<br><span style="font-size:10px;">${f.name}</span><br><button onclick="deleteFile(${i})" style="font-size:8px;">Del</button></div>`).join('');
    }
    function deleteFile(i) {
        trash.push({name: files[i].name, type:'file', data: files[i]});
        files.splice(i,1); saveAll(); renderExplorer(); updateBinList();
    }
    function updateBinList() {
        const list = document.getElementById('bin-list');
        list.innerHTML = trash.map((f, i) => `<div>üóëÔ∏è ${f.name} <button onclick="restoreFromBin(${i})">Restore</button></div>`).join('') || "Empty";
    }
    function restoreFromBin(i) {
        if(trash[i].type === 'file') files.push(trash[i].data);
        trash.splice(i, 1); saveAll(); renderExplorer(); updateBinList();
    }
    function emptyBin() { trash = []; saveAll(); updateBinList(); }
    function saveAll() { localStorage.setItem('sysFiles', JSON.stringify(files)); localStorage.setItem('sysTrash', JSON.stringify(trash)); localStorage.setItem('sysTasks', JSON.stringify(tasks)); }
    let curV = "0", pV = null, opr = null, rst = false;
    function calcNum(n) { if(curV === "0" || rst) { curV = n; rst = false; } else { curV += n; } document.getElementById('calc-display').innerText = curV; }
    function calcOp(o) { pV = curV; opr = o; rst = true; }
    function calcRes() { if(!opr) return; let a=parseFloat(pV), b=parseFloat(curV), res=0; if(opr==='+')res=a+b; if(opr==='-')res=a-b; if(opr==='*')res=a*b; if(opr==='/')res=a/b; curV=String(res); opr=null; rst=true; document.getElementById('calc-display').innerText = curV; }
    function calcClear() { curV="0"; pV=null; opr=null; rst=false; document.getElementById('calc-display').innerText="0"; }
    function toggleStart() { const m = document.getElementById('start-menu'); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
    function hideUI() { document.getElementById('start-menu').style.display = 'none'; document.getElementById('calendar-popup').style.display = 'none'; }
    function updateClock() { setInterval(() => { const d = new Date(); document.getElementById('clock').innerText = d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0'); }, 1000); }
    function initPaint() { const c = document.getElementById('paint-canvas'); const ctx = c.getContext('2d'); let d = false; c.onmousedown=()=>{d=true;ctx.beginPath();}; c.onmouseup=()=>d=false; c.onmousemove=(e)=>{if(d){ctx.strokeStyle=document.getElementById('paint-color').value;ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();}};}
    function clearPaint() { document.getElementById('paint-canvas').getContext('2d').clearRect(0,0,200,150); }
    function runCmd() { const i = document.getElementById('term-in'), o = document.getElementById('term-out'); o.innerHTML += `<br>C:\&gt; ${i.value}`; i.value = ""; o.scrollTop = o.scrollHeight; }
    function updateTaskView() { const list = document.getElementById('task-view-list'); list.innerHTML = tasks.map((t, i) => `<div>${t.name}</div>`).join('') || "No tasks."; }
    function saveProfile() { document.getElementById('start-username').innerText = document.getElementById('pref-username').value; }
    function setCustomWP() { document.body.style.backgroundImage = `url(${document.getElementById('wp-url').value})`; }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function restartSystem() { location.reload(); }
    function triggerBSOD() { document.body.style.background = "blue"; document.body.innerHTML = ""; }
    function toggleCalendar() { const c = document.getElementById('calendar-popup'); c.style.display = c.style.display === 'block' ? 'none' : 'block'; }
    function showContextMenu(e) { e.preventDefault(); const m = document.getElementById('context-menu'); m.style.display = 'block'; m.style.left = e.clientX+'px'; m.style.top = e.clientY+'px'; }
    function executeRun() { openWin(document.getElementById('run-input').value + '-win'); }
    function addTask() { tasks.push({name: document.getElementById('taskName').value}); saveAll(); updateTaskView(); }
</script>
</body>
</html>
